<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <title>æ‰«é›·</title>
  <style>
    #bar {
      text-align: center;
      margin-bottom: 20px;
    }

    .bar {
      height: 25px;
      width: 150px;
      line-height: 25px;
      display: inline-block;
      border: solid 1px #000;
      margin-left: 20px;
      margin-right: 20px;
    }

    #grid {
      margin: auto;
    }

    .blocks {
      width: 30px;
      height: 30px;
      line-height: 30px;
      display: block;
      text-align: center;
      border: solid 1px #000;
      user-select: none;
      cursor: pointer;
    }

    .blocks:hover {
      background: #0af;
    }
  </style>
</head>

<!-- ondragstart:é˜²æ‹–æ‹½ç”Ÿæˆæ–°é¡µé¢ oncontextmenu:å±è”½å³é”®èœå•-->

<body ondragstart='return false' oncontextmenu='self.event.returnValue=false'>

  <div id='bar'>
    <span class='bar'>total :<label id='count'>0</label></span>
    <span class='bar'>labels :<label id='sign'>0</label></span>
    <span class='bar'>time :<label id='time'>0</label>s</span>
  </div>
  <table id='grid'></table>

  <script>
    var row = 30; //è¡Œæ•°
    var col = 30; //åˆ—æ•°
    var maxCount = 100; //æœ€å¤§åœ°é›·æ•°é‡
    var isFirstOpen = true; //ç¬¬ä¸€æ¬¡æ‰“å¼€æ–¹æ ¼
    var grid = init_grid(); //åˆå§‹åŒ–
    var count = document.getElementById('count'); //æ€»é›·æ•°
    var sign = document.getElementById('sign'); //æ ‡è®°æ•°
    var time = document.getElementById('time'); //è®¡æ—¶
    count.innerText = maxCount;

    //åˆå§‹åŒ–çŸ©é˜µ (row-è¡Œæ•° col-åˆ—æ•°)
    function init_grid() {

      //ç”ŸæˆçŸ©é˜µhtml <tr>--è¡Œæ ‡ç­¾ <td>--åˆ—æ ‡ç­¾
      let gridHtml = '';
      for (let i = 0; i < row; i++) {
        gridHtml += '<tr>'
        for (let j = 0; j < col; j++) {
          gridHtml +=
            '<td><span class="blocks" onmousedown="block_click(' + i + ',' + j + ',event)"></span></td>';
        }
        gridHtml += '<tr>'
      }
      //å†™å…¥html
      document.getElementById('grid').innerHTML = gridHtml;

      //è¿”å›çŸ©é˜µäºŒç»´æ•°ç»„
      let blocks = document.getElementsByClassName('blocks');
      let grid = new Array();
      for (let i = 0; i < blocks.length; i++) {
        if (i % col === 0) {
          grid.push(new Array());
        }
        //åˆå§‹åŒ–è®¡é›·æ•°
        blocks[i].count = 0;
        grid[parseInt(i / col)].push(blocks[i]);
      }
      return grid;
    }

    //æ–¹æ ¼ç‚¹å‡»äº‹ä»¶ _iï¼šåæ ‡i _j:åæ ‡j e:é¼ æ ‡äº‹ä»¶
    function block_click(_i, _j, e) {

      //è·³è¿‡å·²æ‰“å¼€çš„æ–¹æ ¼
      if (grid[_i][_j].isOpen) {
        return;
      }

      //é¼ æ ‡å·¦é”®æ‰“å¼€æ–¹æ ¼
      if (e.button === 0) {

        //ç¬¬ä¸€æ¬¡æ‰“å¼€
        if (isFirstOpen) {

          isFirstOpen = false;
          let count = 0; //å½“å‰åœ°é›·æ•°

          //ç”Ÿæˆåœ°é›·
          while (count < maxCount) {

            //ç”Ÿæˆéšæœºåæ ‡
            let ri = Math.floor(Math.random() * row);
            let rj = Math.floor(Math.random() * col);

            //åæ ‡ä¸ç­‰äºç¬¬ä¸€æ¬¡ç‚¹å‡»æ–¹æ ¼çš„åæ ‡ && éé›·æ–¹æ ¼
            if (!(ri === _i && rj === _j) && !grid[ri][rj].isMine) {
              grid[ri][rj].isMine = true; //è‡ªå®šä¹‰å±æ€§isMineä»£è¡¨æ–¹æ ¼ä¸ºåœ°é›·
              count++; //å½“å‰åœ°é›·æ•°+1

              //æ›´æ–°ä¹å®«æ ¼å†…éé›·æ–¹æ ¼çš„è®¡é›·æ•°
              for (let i = ri - 1; i < ri + 2; i++) {
                for (let j = rj - 1; j < rj + 2; j++) {
                  //åˆ¤æ–­åæ ‡é˜²è¶Šç•Œ
                  if (i > -1 && j > -1 && i < row && j < col) {
                    //è®¡é›·æ•°+1
                    grid[i][j].count++;
                  }
                }
              }
            }
          }
        }

        //æ‰§è¡Œæ‰“å¼€æ–¹æ ¼å‡½æ•°
        block_open(_i, _j);

        //æ‰“å¼€æ–¹æ ¼å‡½æ•°
        function block_open(_i, _j) {

          let block = grid[_i][_j];
          op(block);

          //è®¾å®šæ‰“å¼€æ–¹æ ¼çš„çŠ¶æ€ä¸æ ·å¼
          function op(block) {
            block.isOpen = true; //isOpenä¸ºè‡ªå®šä¹‰å±æ€§ï¼Œè®¾ç½®ä¸ºtrueä»£è¡¨å·²æ‰“å¼€
            block.style.background = '#ccc'; //å°†èƒŒæ™¯è®¾ç½®ä¸ºç°è‰²
            block.style.cursor = 'default'; //å°†é¼ æ ‡åœç•™æ ·å¼è®¾ç½®ä¸ºé»˜è®¤
          }

          if (block.isMine) {
            //è¸©é›·
            block.innerHTML = 'ğŸ†'; //æ˜¾ç¤ºä¸º 'é›·'
            //éå†çŸ©é˜µæ‰“å¼€æ‰€æœ‰çš„åœ°é›·æ–¹æ ¼
            for (let i = 0; i < row; i++) {
              for (let j = 0; j < col; j++) {
                //æ‰¾åˆ°åœ°é›·
                block = grid[i][j];
                if (!block.isOpen && block.isMine) {
                  op(block); //è®¾ç½®æ‰“å¼€çŠ¶æ€å’Œæ ·å¼
                  block.innerHTML = 'ğŸ‡'; //æ˜¾ç¤ºä¸º 'é›·'
                }
              }
            }
            //æç¤ºæ¸¸æˆç»“æŸ
            alert("game over!");
          } else if (block.count === 0) {
            //æ‰“å¼€è®¡é›·æ•°ä¸º0çš„æ–¹æ ¼
            //éå†ä¹å®«æ ¼å†…çš„æ–¹æ ¼
            for (let i = _i - 1; i < _i + 2; i++) {
              for (let j = _j - 1; j < _j + 2; j++) {
                //åˆ¤æ–­æ˜¯å¦è¶Šç•Œ&&è·³è¿‡å·²æ‰“å¼€çš„æ–¹æ ¼&&éé›·
                if (i > -1 && j > -1 && i < row && j < col && !grid[i][j].isOpen && !grid[i][j].ismine) {
                  //é€’å½’æ‰“å¼€æ–¹æ ¼å‡½æ•°
                  block_open(i, j);
                }
              }
            }
          } else {
            //æ‰“å¼€è®¡é›·æ•°ä¸ä¸º0çš„æ–¹æ ¼
            block.innerHTML = block.count; //æ˜¾ç¤ºè®¡é›·æ•°
          }

        }
      }
      //é¼ æ ‡å³é”®æ ‡è®°æ–¹æ ¼
      else if (e.button === 2) {

        let block = grid[_i][_j];
        if (block.innerHTML !== 'ğŸˆ') {
          block.innerHTML = 'ğŸˆ';
          ++sign.innerText;
        } else {
          block.innerHTML = '';
          --sign.innerText;
        }
      }

      //åˆ¤æ–­æ¸¸æˆæ˜¯å¦ç»“æŸ(æ‰€æœ‰çš„éé›·æ–¹æ ¼å·²æ‰“å¼€)
      for (let i = 0; i < row; i++) {
        for (let j = 0; j < col; j++) {
          if (!grid[i][j].isMine && !grid[i][j].isOpen) {
            return;
          }
        }
      }
      alert("You win!");
    }
  </script>
</body>

</html>
